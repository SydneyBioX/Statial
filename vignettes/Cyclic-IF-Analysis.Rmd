---
title: "Analysis of Cyclic Immunofluorescence data with SPICY"
date: "`r BiocStyle::doc_date()`"
author:
- name: Nicolas Canete
  affiliation:  
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  email: ncan4475@uni.sydney.edu.au
- name: Ellis Patrick
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
package: "`r BiocStyle::pkg_ver('spicyR')`"
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{"Analysis of Cyclic IF data with spicyR"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---


```{r warning=FALSE}
# load required packages
suppressPackageStartupMessages({
    library(spicyR)
    library(SummarizedExperiment)
})
```

# Overview

The folowing will provide a step-by-step guide to a typical analysis of cyclic immunofluorescence images. These step will include:

- Loading data.
- Image registration.
- Cell segmentation.
- Autofluorescence removal.
- Cell subtype classification.
- Tissue compartment estimation.
- Cell density analysis.
- Nearest neighbours community analysis.
- Differential interaction analysis.

```{r}
library(spatstat)
library(tidyverse)
set.seed(51773)
x <- round(c(runif(200),runif(200)+1,runif(200)+2,runif(200)+3),4)
y <- round(c(runif(200),runif(200)+1,runif(200)+2,runif(200)+3),4)

cells <- data.frame(x,y,cellTypes = factor(paste('c',rep(rep(c(1:2),rep(200,2)),2),sep = '')), SampleID = rep(c('s1', 's2'),c(400,400)))

LCurves <- localLCurves(cells, Rs = c(0.01,0.1, 0.5, 1))

p1 <- ppp(x, y, c(0,4), c(0,4), marks = data.frame(cells <- cells$cellTypes,region = factor(paste('r',rep(rep(c(1:2),rep(200,2)),2),sep = '')) ))

df = data.frame(x = p1$x, y = p1$y, region = p1$marks$region, marks = p1$marks$cells)
hatching = c(6,7)
names(hatching) = c('r1','r2')
hatching = NULL
p <- ggplot(df,aes(x = x,y = y, colour = marks)) + geom_point() + geom_hatching(aes(region = region),show.legend = TRUE, window = "concave", line.spacing = 51, nbp = 250, line.width = 1.5) 
q = p  + theme_minimal()+ scale_region() 
q

p <- ggplot(df,aes(x = x,y = y, colour = marks)) + geom_point() + geom_hatching(aes(region = region),show.legend = TRUE, window = "concave", line.spacing = 51, nbp = 250, line.width = 1.5) 
q = p  + theme_minimal()+ scale_region_manual(values = 6:7) 
q


p <- ggplot(df,aes(x = x,y = y, colour = marks, region = region)) + geom_point() + geom_hatching(window = "concave", line.spacing = 51, nbp = 250, line.width = 1.5) 
q = p  + theme_minimal()+ scale_region_manual(values = 6:7, labels = c('ab','cd')) 
q


```


