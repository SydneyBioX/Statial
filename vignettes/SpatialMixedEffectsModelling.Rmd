---
title: "Spatial Mixed-Effects Modelling"
date: "`r BiocStyle::doc_date()`"
author:
- name: Nicolas Canete
  affiliation:  
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  email: nicolas.canete@sydney.edu.au
- name: Ellis Patrick
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
package: "`r BiocStyle::pkg_ver('spicyR')`"
vignette: >
  %\VignetteIndexEntry{"spatialMEM"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---


```{r warning=FALSE, message=FALSE}
# load required packages
library(spicyR)
library(ggplot2)
```
 

# Overview
The following will provide a step-by-step guide on how to use mixed-effects models to analyse multiple image datasets.

# Mixed-effects modelling

## Reading in the data

Here, we use a melanoma image dataset with two conditions: Responders and Non-Responders. With this data set, we want to see if there are differences in how cell types are localised with respect to each other.

```{r message=FALSE}
data("melanomaResponders")
cells
location(cells)
phenotype(cells)
```
Note that `cellType` can be some combination of the expression of CD8, PD1 or PDL1, or is SOX10+.


## Test for change in colocalisation between Responders and Non-Responders for a specific pair of cells.

Firstly, we can see if whether one cell type tends to be around another cell type in one condition compared to the other.
```{r}
spicyTest <- spicy(cells, condition = "condition", subject = "subject", from = "CD8+PD1+PDL1-", to = "CD8-PD1+PDL1+")
spicyTest
top(spicyTest)
```
As the coefficient is negative, we find that CD8-PD1+PDL1+ cells are more likely to be found around CD8+D1+PDL1- cells in Non-Responders.

## Test for change in colocalisation between Responders and Non-Responders for all cells.
Here, we can apply the function to all pairwise cell type combinations, and represent this in a heatmap.

```{r}
spicyTest <- spicy(cells, condition = "condition", subject = "subject")
spicyTest
top(spicyTest)  

spatialMEMMultiPlot(spicyTest, breaks=c(-3, 3, 0.5))
```

To improve statistical power, we can perform bootstrapping.
```{r}
spicyTest <- spicy(cells, condition = "condition", subject = "subject", nsim = 199)
spicyTest
top(spicyTest)  

spatialMEMMultiPlot(spicyTest, breaks=c(-3, 3, 0.5))
```
Indeed, we get improved statistical power compared to the previous method.




<!-- ## Obtaining measure of localisation -->
<!-- Here, we use the `pairwise` funciton to measure the degree of pairwise localisation between CD8+PD1+PDL1+ cells. -->
<!-- ```{r} -->
<!-- pairwiseVals <- getPairwise(cells, from = "CD8+PD1+PDL1+", to = "CD8+PD1+PDL1+") -->
<!-- ``` -->





<!-- We can produce boxplots to see if any differences exist within our two conditions. -->
<!-- ```{r} -->
<!-- spatialData <- data.frame(Pairwise = pairwiseVals, -->
<!--                           Condition = phenotype(cells)$condition) -->

<!-- ggplot(spatialData, aes(x=Condition, y=Pairwise, color = Condition)) + -->
<!--     geom_boxplot() + -->
<!--     theme_classic() -->
<!-- ``` -->
<!-- Indeed, there appears to be an increase in the localisation of CD8+PD1+PDL1+ cells. -->



<!-- ## Performing mixed-effects modelling -->

<!-- Finally, we can use `spatialMEM` to perform mixed-effects modelling. -->
<!-- ```{r} -->
<!-- mixed.lmer <- spatialMEM(cells, -->
<!--                          pairwise = pairwiseVals,  -->
<!--                          from = "CD8+PD1+PDL1+",  -->
<!--                          to = "CD8+PD1+PDL1+") -->

<!-- summary(mixed.lmer) -->
<!-- ``` -->

<!-- Here we find that there is a decrease in the localisation of CD8+PD1+PDL1+ cells between the Non-Responders and the Responders, with a p-value of 0.00804. -->

<!-- ## Performing random effects modelling and bootstrapping -->
<!-- To obtain more precise p-values, we can use bootstrap by resampling the data and using the gradient as a statistic. This is performed using `spatialMEMBootstrap`. -->
<!-- ```{r} -->
<!-- set.seed(51773) -->
<!-- pVal <- spatialMEMBootstrap(mixed.lmer, nsim = 999) -->
<!-- pVal -->
<!-- ``` -->
<!-- Again, we find that there is a decrease in the localisation of CD8+PD1+PDL1+ cells between the Non-Responders and the Responders, with a p-value of 0. -->

<!-- # Mixed-effects modelling on all pairwise cell type combinations -->
<!-- We can perform mixed-effects modelling as above on all pairwise cell type combinations using `spatialMEMMulti`. We can specify whether or not to use bootstrapping to obtain p-values by setting the parameter `nsim`. For speed, we simply set it to the default `NULL`. -->
<!-- ```{r} -->
<!-- df <- spatialMEMMulti(cells, nsim = NULL) -->
<!-- head(df) -->
<!-- ``` -->
<!-- We get a data frame of p-values for each pairwise comparison. We can represent this as a heatmap using the `spatialMEMMultiPlot` function. -->
<!-- ```{r} -->
<!-- spatialMEMMultiPlot(df, -->
<!--                     fdr = FALSE, -->
<!--                     breaks = c(-4,4,0.5), -->
<!--                     col=c("blue", "white", "red")) -->
<!-- ``` -->
<!-- The vertical axis represents the 'from' cells, while the horizontal axis represents the 'to' cells. Negative values represent a decrease in localisation between the two groups. -->

